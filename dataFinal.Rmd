---
title: "Data Final"
author: "Kaleb"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

require(tidyverse)
require(knitr)
require(kableExtra)
require(papeR)
require(broom)
library(lubridate)
library(leaflet)
library(ggthemes)
library(mapview)

df <- read.csv("master_data.csv", stringsAsFactors = TRUE)
df$Date <- mdy(df$Date)

for (i in 1:nrow(df)) {
  if (df[i, "Site"] == "LR") {
    df[i, "Site_Lat"] = 43.07385
  }
}

#converts all years into same year so that figures can show months
all_year <- function(x) {
  year(x) <- 1
  return(x)
} 

```

# Leaflet works, epic
 
```{r}
# uncomment if you want to recreate leaflet plot

#map <- leaflet(data = df) %>% 
  #addTiles() %>% 
    #addMarkers( lng = ~Site_Long, lat = ~Site_Lat)
#mapshot(map, file = "Rplot.png")
```
![map of Great Bay area with markers for sampling sites](./Rplot.png)

# physiochemical stuff

```{r}
dfLong <- df[c(1,7,8,9)] %>% 
  pivot_longer(Temp:pH, names_to = "physiochemical", values_to = "values")
dfLong$year <- format(dfLong$Date, "%Y")
```

```{r}

physiochemicalPlot <- dfLong %>% 
  ggplot(aes(x = all_year(Date), y = values), color = year) +
  geom_line(aes(color = year)) + 
  xlab("Month") +
  facet_grid(dfLong$physiochemical~., scales = "free", labeller = as_labeller(c(Temp = "Temperature (Â°C)", Sal = "Salinity", pH = "pH")))  +
     ylab(NULL) +
  theme_minimal()

physiochemicalPlot
```



# larvae type across year and site
```{r}
dfLarvalType <- df %>% 
  pivot_longer(D:V, names_to = "larvalType", values_to = "avgCount")
head(dfLarvalType)
```


```{r}
larvalYearSite <- dfLarvalType %>% 
  ggplot(aes(x = all_year(Date), y = avgCount)) +
  geom_line(aes(color = Site)) +
  labs(x = "Month", y = "Average Larval Count") +
  facet_wrap(year(Date)~larvalType, nrow = 3, scales = "free_y") +
  theme_minimal()
larvalYearSite
```

```{r}
larvalTypeTable <- dfLarvalType
larvalTypeTable$year <- format(larvalTypeTable$Date, "%Y")
larvalTypeTable$year <- factor(larvalTypeTable$year)
larvalTypeTable$larvalType <- factor(larvalTypeTable$larvalType)
levels(larvalTypeTable$larvalType) <- c("D-hinge", "Veliger")

larvalTypeTable2 <- larvalTypeTable %>% 
  group_by(year, larvalType) %>% 
  dplyr::summarise(avgCount = mean(avgCount)) %>% 
  mutate(avgCount = formatC(avgCount, digits = 2, format = "fg")) %>% 
  pivot_wider(names_from = year, values_from = avgCount)

kable(larvalTypeTable2, align = "l")
```

```{r}
larvalTypeTable3 <- larvalTypeTable %>% 
  group_by(year, larvalType, Site) %>%
  dplyr::summarise(avgCount = mean(avgCount)) %>% 
  mutate(avgCount = formatC(avgCount, digits = 2, format = "fg")) %>% 
  pivot_wider(names_from = year, values_from = avgCount) %>% 
  arrange(larvalType) %>% 
  select(larvalType, everything())

kable(larvalTypeTable3, align = "l", format = "latex", booktabs = TRUE) %>% 
  pack_rows(index = table(fct_inorder(larvalTypeTable3$larvalType)))
```
```{r}
larvalBox <- larvalTypeTable %>% 
  ggplot(aes(x = year, y = avgCount)) +
  geom_boxplot() + 
  geom_jitter() +
  labs(x = "Year", y = "Larval Count") +
  facet_wrap(.~larvalType, scales = "free_y")
larvalBox
```


# ANOVA stuff

```{r}
# D
dfD <- dfLarvalType %>% 
  filter(larvalType == "D")
dfD$year <- format(dfD$Date, "%Y")

dAOV <- aov(avgCount ~ year + Site, data = dfD)

summary(dAOV)

anova(dAOV) %>% 
  #tidy() %>%
  prettify() %>% 
  kable(align = "l")

# V
dfV <- dfLarvalType %>% 
  filter(larvalType == "V")
dfV$year <- format(dfV$Date, "%Y")

vAOV <- aov(avgCount ~ year + Site, data = dfV)

summary(vAOV)

anova(vAOV) %>% 
  #tidy %>%
  prettify() %>% 
  kable(align = "l")
```

```{r}
summary(lm(avgCount ~ Temp, data = dfD)) %>% 
  prettify() %>% 
  kable()
summary(lm(avgCount ~ Sal, data = dfD)) %>% 
  prettify() %>% 
  kable()
summary(lm(avgCount ~ pH, data = dfD)) %>% 
  prettify() %>% 
  kable()

summary(lm(avgCount ~ Temp, data = dfV)) %>% 
  prettify() %>% 
  kable()
summary(lm(avgCount ~ Sal, data = dfV)) %>% 
  prettify() %>% 
  kable()
summary(lm(avgCount ~ pH, data = dfV)) %>% 
  prettify() %>% 
  kable()


```




